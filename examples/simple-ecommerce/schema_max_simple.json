{
    "kind": "system",
    "type": "microservices",
    "domain": "ecommerce",
    "description": "This schema defines a fictional ecommerce microservices system context for interaction with LLMs.\nIt includes services for user management and email verification.\nEach service is described with its API endpoints, data models, dependencies,\nruntime configurations, CI pipelines, and analysis feedback.",
    "runtime": {
        "production": {
            "description": "AWS EKS cluster in us-west-2 region, 4-8 nodes, autoscaling enabled.\nAWS Secrets Manager, Prometheus and Grafana for monitoring.",
            "stack": [
                "kubernetes",
                "aws",
                "prometheus",
                "grafana"
            ]
        },
        "development": {
            "backend": "local minikube",
            "nodes": "1",
            "secrets": "local vault"
        }
    },
    "services": {
        "user_service": {
            "kind": "service",
            "name": "user_service",
            "annotations": [
                "PATH(github.com/org/ecommerce/user-service/)",
                "CALLS(system.verification_service)"
            ],
            "description": "Handles user registration, authentication, and profile management.",
            "langs": [
                "go",
                "protobuf",
                "yaml"
            ],
            "repos": [
                "github.com/org/ecommerce/user-service",
                "github.com/org/ecommerce/user-service-deployment"
            ],
            "runtime": {
                "development": {
                    "backend": "k8s",
                    "namespace": "ecommerce",
                    "replicas": "1",
                    "autoscaling": "disabled",
                    "cpu_request": "500m",
                    "memory_request": "256Mi",
                    "cpu_limit": "1",
                    "memory_limit": "512Mi",
                    "deployment_name": "user-service",
                    "ports_exposed": [
                        "50051"
                    ],
                    "annotations": [
                        "PATH(github.com/org/ecommerce/user-service-deployment/deployment/dev/)"
                    ]
                },
                "production": {
                    "replicas": "3-10",
                    "autoscaling": "cpu_target =70%",
                    "cpu_request": "1000m",
                    "memory_request": "512Mi",
                    "cpu_limit": "2000m",
                    "memory_limit": "1024Mi",
                    "annotations": [
                        "PATH(github.com/org/ecommerce/user-service-deployment/deployment/prod/)",
                        "BASE(system.user_service.runtime.development)",
                        "DO_NOT_EDIT"
                    ]
                },
                "annotations": [
                    "PATH(github.com/org/ecommerce/user-service-deployment/deployment/)"
                ]
            },
            "ci": {
                "backend": "circleci",
                "steps": {
                    "CheckoutCode": "pull code from repo",
                    "SetupGo": "setup Go 1.21 environment",
                    "InstallDependencies": "install project dependencies",
                    "RunTests": "execute unit and integration tests",
                    "RunLinters": "run code linters for quality checks",
                    "BuildBinary": "compile the Go binary",
                    "BuildDockerImage": "create Docker image",
                    "PushDockerImage": "push Docker image to AWS ECR"
                },
                "annotations": [
                    "PATH(github.com/org/ecommerce/user-service-deployment/.circleci/config.yml)"
                ]
            },
            "dependencies": {
                "postgres": "main database",
                "redis": "session cache",
                "verification_service": "grpc VerifyEmail (fallback http POST /verify)"
            },
            "api": [
                {
                    "type": "grpc",
                    "endpoints": [
                        "GetUser (GetUserRequest {uuid:str}) -> (user:User {name:str, email:str, verified:bool}?, error:str?) [auth:user_or_admin, cache:5m, idempotent:true]",
                        "CreateUser (CreateUserRequest {name:str, email:str, password:str}) -> (uuid:str?, error:str?) [auth:none, rate_limit:10/m]"
                    ]
                },
                {
                    "type": "http",
                    "endpoints": [
                        "GET /users/{id} -> JSON{user:User {name:str, email:str, verified:bool}?, error:str?} [auth:user_or_admin, cache:5m, idempotent:true]",
                        "POST /users JSON{name:str, email:str, password:str} -> JSON{uuid:str?, error:str?} [auth:none, rate_limit:10/m]"
                    ],
                    "annotations": [
                        "DELETED(timestamp:2024-05-01T12:00:00Z, reason:Migrated to gRPC API)"
                    ]
                }
            ],
            "components": [
                {
                    "kind": "database",
                    "name": "UserRepo",
                    "annotations": [
                        "PATH(github.com/org/ecommerce/user-service/internal/db/)",
                        "CRITICAL"
                    ],
                    "engine": "postgres-12",
                    "description": "Manages user data in Postgres. Managed via migrations.",
                    "components": [
                        {
                            "kind": "table",
                            "name": "users",
                            "attrs": {
                                "id": "UUID (PK)",
                                "name": "VARCHAR (100)",
                                "email": "VARCHAR (100) (UNIQUE)",
                                "password_hash": "VARCHAR (256)",
                                "verified": "BOOLEAN",
                                "created_at": "TIMESTAMP",
                                "updated_at": "TIMESTAMP"
                            }
                        }
                    ],
                    "queries": [
                        "GetByID",
                        "Insert",
                        "Update",
                        "Delete"
                    ]
                },
                {
                    "kind": "cache",
                    "name": "SessionCache",
                    "annotations": [
                        "PATH(github.com/org/ecommerce/user-service/internal/cache/)"
                    ],
                    "engine": "redis-6",
                    "description": "Caches user session data.",
                    "components": [
                        {
                            "kind": "hash",
                            "name": "sessions",
                            "session_id": "VARCHAR (128) hash key",
                            "user_id": "UUID",
                            "data": "JSONB with personal info and preferences",
                            "expires_at": "TIMESTAMP"
                        }
                    ],
                    "operations": [
                        "Set",
                        "Get",
                        "Delete"
                    ]
                },
                {
                    "kind": "struct",
                    "name": "UserService",
                    "annotations": [
                        "PATH(github.com/org/ecommerce/user-service/internal/service/userService.go)"
                    ],
                    "fields": {
                        "-database": "UserRepo",
                        "-cache": "SessionCache",
                        "-verification": "VerificationService"
                    },
                    "methods": {
                        "GetUser": {
                            "def": "+GetUser(uuid string) -> *User",
                            "description": "Retrieves user by UUID."
                        },
                        "UpdateUser": {
                            "def": "+UpdateUser(uuid string, user User) -> (User, error)",
                            "description": "Updates user details excluding password."
                        },
                        "CreateUser": {
                            "def": "+CreateUser(name, email, password string) -> (user User, err error)",
                            "description": "Registers new user and sends verification email.",
                            "algo": "1. Validate basic fields and password strength with validateUserInput\n2. Hash password with sha256\n3. Insert into users table\n4. Call VerifyUser to send verification email",
                            "analysis": {
                                "security": [
                                    "PASSWORD_COMPLEXITY_WEAK"
                                ],
                                "linter": [
                                    "UNHANDLED_ERROR"
                                ]
                            }
                        },
                        "VerifyUser": {
                            "def": "+VerifyUser(email string) -> bool",
                            "description": "Sends verification email to user.",
                            "algo": "1. Generate verification token\n2. Store token in verification service\n3. Send verification email via verification service\n4. Outside of this flow, user clicks link to verify and verification service triggers user's verified status update",
                            "analysis": {
                                "security": [
                                    "TOKEN_INSECURE_GENERATION"
                                ]
                            }
                        },
                        "validateUserInput": {
                            "def": "-validateUserInput(name, email, password string) -> bool",
                            "description": "Validates user input fields:\n- Name: non-empty, max 100 chars\n- Email: valid format\n- Password: minimum 8 chars, includes letters and numbers"
                        }
                    }
                },
                {
                    "kind": "struct",
                    "name": "User",
                    "annotations": [
                        "PATH(github.com/org/ecommerce/user-service/internal/models/user.go)"
                    ],
                    "fields": {
                        "+ID": "UUID",
                        "+Name": "string",
                        "+Email": "string",
                        "-PasswordHash": "string",
                        "+Verified": "bool",
                        "+CreatedAt": "timestamp",
                        "+UpdatedAt": "timestamp"
                    }
                }
            ],
            "llm_feedback": {
                "last_review": "2025-11-20T15:30:00Z",
                "latest_reviewed_commits": {
                    "github.com/org/ecommerce/user-service": "a1b2c3d4e5f6g7h8i9j0k",
                    "github.com/org/ecommerce/user-service-deployment": "z9y8x7w6v5u4t3s2r1q0p"
                },
                "notes": "User service design looks consistent with typical Go microservice patterns.\nIdentified a security issue regarding password hashing algorithm.",
                "issues_found": [
                    {
                        "id": "ISSUE-2025-001",
                        "type": "security",
                        "description": "Password hashing uses SHA256 which is not secure enough.",
                        "recommendation": "Migrate to Argon2id for password hashing."
                    },
                    {
                        "id": "ISSUE-2025-002",
                        "type": "performance",
                        "description": "GetUser endpoint has unoptimized database queries leading to high latency.",
                        "recommendation": "Add indexing on frequently queried fields and optimize SQL queries.",
                        "annotations": [
                            "IGNORE(reason:Low severity, to be addressed in future iteration)"
                        ]
                    }
                ]
            }
        },
        "verification_service": {
            "kind": "service",
            "name": "verification_service",
            "description": "Manages email verification for new users.",
            "langs": [
                "python",
                "protobuf"
            ],
            "repo": "github.com/org/ecommerce/verification-service",
            "runtime": {
                "development": {
                    "backend": "k8s",
                    "namespace": "ecommerce",
                    "replicas": "1",
                    "autoscaling": "disabled",
                    "cpu_request": "300m",
                    "memory_request": "256Mi",
                    "cpu_limit": "600m",
                    "memory_limit": "512Mi",
                    "deployment_name": "verification-service",
                    "ports_exposed": [
                        "8080",
                        "50052"
                    ],
                    "annotations": [
                        "PATH(github.com/org/ecommerce/verification-service/deployment/dev/)"
                    ]
                },
                "production": {
                    "replicas": "2-5",
                    "autoscaling": "cpu_target =70%",
                    "cpu_request": "600m",
                    "memory_request": "512Mi",
                    "cpu_limit": "1200m",
                    "memory_limit": "1024Mi",
                    "annotations": [
                        "PATH(github.com/org/ecommerce/verification-service/deployment/prod/)",
                        "BASE(system.verification_service.runtime.development)"
                    ]
                },
                "annotations": [
                    "PATH(github.com/org/ecommerce/verification-service/)"
                ]
            },
            "api": [
                {
                    "type": "grpc",
                    "endpoints": [
                        "VerifyEmail (VerifyEmailRequest {email:str}) -> (success:bool, error:str?) [auth:internal, rate_limit:20/m, idempotent:true]"
                    ]
                },
                {
                    "type": "http",
                    "endpoints": [
                        "POST /verify JSON{email:str} -> JSON{success:bool, error:str?} [auth:none, rate_limit:5/m]"
                    ]
                }
            ]
        }
    }
}